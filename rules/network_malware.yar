/*
    网络恶意行为检测规则
    检测数据外传、C2通信等
*/

rule Network_Discord_Webhook {
    meta:
        description = "【高危】使用 Discord Webhook (常用于数据外传)"
        severity = "high"
        category = "数据外传"
    strings:
        $hook1 = "discord.com/api/webhooks" nocase
        $hook2 = "discordapp.com/api/webhooks" nocase
        $hook3 = /https:\/\/discord\.com\/api\/webhooks\/[0-9]+\/[A-Za-z0-9_-]+/
    condition:
        any of them
}

rule Network_Telegram_Bot {
    meta:
        description = "【高危】使用 Telegram Bot API (可能外传数据)"
        severity = "high"
        category = "数据外传"
    strings:
        $tg1 = "api.telegram.org/bot" nocase
        $tg2 = /https:\/\/api\.telegram\.org\/bot[0-9]+:[A-Za-z0-9_-]+/
        $tg3 = "sendDocument" nocase
        $tg4 = "sendMessage" nocase
    condition:
        $tg1 or $tg2 or ($tg3 and $tg4)
}

rule Network_Suspicious_Upload {
    meta:
        description = "【高危】向可疑服务上传数据"
        severity = "high"
        category = "数据外传"
    strings:
        $paste1 = "pastebin.com" nocase
        $paste2 = "hastebin.com" nocase
        $paste3 = "ghostbin" nocase
        $file1 = "file.io" nocase
        $file2 = "transfer.sh" nocase
        $file3 = "anonfiles" nocase
        $file4 = "0x0.st" nocase
    condition:
        any of them
}

rule Network_Raw_IP_Connection {
    meta:
        description = "【敏感】直接连接 IP 地址 (绕过域名)"
        severity = "medium"
        category = "可疑通信"
    strings:
        // IPv4 + 端口
        $ip = /https?:\/\/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}(:[0-9]+)?/
    condition:
        #ip > 0
}

rule Network_Base64_URL {
    meta:
        description = "【高危】Base64 编码的 URL (隐藏真实地址)"
        severity = "high"
        category = "混淆通信"
    strings:
        $b64_http = "aHR0c" // "http" base64
        $b64_https = "aHR0cHM" // "https" base64
        $decode1 = "base64" nocase
        $decode2 = "b64decode" nocase
        $decode3 = "atob" nocase
        $decode4 = "FromBase64" nocase
    condition:
        ($b64_http or $b64_https) and any of ($decode*)
}

rule Network_Crypto_Mining {
    meta:
        description = "【严重】可能进行加密货币挖矿"
        severity = "critical"
        category = "资源滥用"
    strings:
        $pool1 = "stratum+tcp" nocase
        $pool2 = "stratum+ssl" nocase
        $pool3 = "pool.minergate" nocase
        $pool4 = "xmrpool" nocase
        $algo1 = "cryptonight" nocase
        $algo2 = "randomx" nocase
        $wallet = /[48][0-9AB][1-9A-HJ-NP-Za-km-z]{93}/ // Monero 钱包地址
    condition:
        any of them
}

rule Network_C2_Beacon {
    meta:
        description = "【严重】疑似 C2 通信特征"
        severity = "critical"
        category = "远程控制"
    strings:
        $beacon1 = "beacon" nocase
        $beacon2 = "heartbeat" nocase
        $beacon3 = "checkin" nocase
        $cmd1 = "execute" nocase
        $cmd2 = "shell" nocase
        $cmd3 = "command" nocase
        // 定时器
        $timer1 = "setInterval" nocase
        $timer2 = "setTimeout" nocase
        $timer3 = "Timer" nocase
    condition:
        (any of ($beacon*)) and (any of ($cmd*) or any of ($timer*))
}

rule Network_Ngrok_Tunnel {
    meta:
        description = "【高危】使用 Ngrok 隧道 (隐藏真实服务器)"
        severity = "high"
        category = "隐蔽通信"
    strings:
        $ngrok1 = "ngrok.io" nocase
        $ngrok2 = "ngrok.com" nocase
        $ngrok3 = /[a-z0-9]+\.ngrok\.io/
    condition:
        any of them
}
